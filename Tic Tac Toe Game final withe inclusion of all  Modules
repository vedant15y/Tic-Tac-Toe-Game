#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <time.h>

void win(int player, int winner, char pos[]);

//* ---------- MCQ bank ---------- */
#define QCOUNT 10
const char *questions[QCOUNT] = {
    "Which operator assigns a value in C?",
    "What is the result of 10 + 5 * 2 (int arithmetic)?",
    "Which is a logical operator?",
    "What does '==' do?",
    "What is 5 % 2?",
    "Which operator dereferences a pointer?",
    "Arrays in C start at index:",
    "Which has higher precedence?",
    "Which is the ternary operator?",
    "Associativity of assignment '=' is:"
};

const char *options[QCOUNT][4] = {
    {"=", "==", ":=", "<-"},
    {"30", "20", "25", "15"},
    {"&", "&&", "|", "/"},
    {"Assignment", "Equality check", "Inequality check", "Logical AND"},
    {"2", "2.5", "1", "0"},
    {"&", "*", "->", "."},
    {"1", "0", "-1", "Depends"},
    {"*", "=", "&&", "++"},
    {"?:", "::", "??", "if-else"},
    {"Left to Right", "Right to Left", "None", "Depends"}
};
int correct_idx[QCOUNT] = { 0,1,1,1,2,1,1,3,0,1 };

//* ---------- Helpers ---------- */
static char read_choice_abcd(void) {
    int ch = getchar();
    while (ch == ' ' || ch == '\t' || ch == '\r') ch = getchar();
    if (ch == '\n' || ch == EOF) return 'X';
    char c = (char)toupper((unsigned char)ch);
    int d; while ((d = getchar()) != '\n' && d != EOF) {}
    if (c >= 'A' && c <= 'D') return c;
    return 'X';
}

//* Ask one MCQ (no randomization of options). Return 1 if correct. */
static int mcq_correct_once(void) {
    int qi = rand() % QCOUNT;   // random question only
    printf("\nMCQ: Answer correctly to progress.\n");
    printf("%s\n", questions[qi]);
    printf("  A) %s\n", options[qi][0]);
    printf("  B) %s\n", options[qi][1]);
    printf("  C) %s\n", options[qi][2]);
    printf("  D) %s\n", options[qi][3]);
    printf("Your answer (A-D): ");

    char ans = read_choice_abcd();
    char correct_letter = 'A' + correct_idx[qi];

    if (ans == correct_letter) {
        printf("Correct.\n");
        return 1;
    }
    if (ans == 'X') {
        printf("Invalid choice. Try again.\n");
        return 0;
    }
    printf("Wrong answer. Try again.\n");
    return 0;
}

//* Ask until 'needed' correct answers are given (no turn loss). */
static void mcq_gate_until_correct_n(int needed) {
    int got = 0;
    while (got < needed) {
        printf("\n[Level requires %d correct answer%s. Progress: %d/%d]\n",
               needed, (needed==1?"":"s"), got, needed);
        if (mcq_correct_once()) {
            got++;
        }
    }
}

int main() {
    srand((unsigned)time(NULL));

    int winner = 0, count = 0;
    int index, player, i;
    char pos[9], sign;

    // -------- LEVEL SELECTION (1..5) --------
    int level = 1;
    printf("Select Level (1-5): ");
    if (scanf("%d", &level) != 1) {
        int c; while ((c = getchar()) != '\n' && c != EOF) {}
        level = 1;
    }
    if (level < 1) level = 1;
    if (level > 5) level = 5;
    // clear the newline after level input to keep later reads clean
    { int c; while ((c = getchar()) != '\n' && c != EOF) {} }

    for (i = 0; i < 9; i++) pos[i] = ' ';

    while (count < 9 && winner != 1) {
        // display board
        printf("\n");
        printf(" %c | %c | %c\n", pos[0], pos[1], pos[2]);
        printf("---+---+---\n");
        printf(" %c | %c | %c\n", pos[3], pos[4], pos[5]);
        printf("---+---+---\n");
        printf(" %c | %c | %c\n", pos[6], pos[7], pos[8]);

        // player definition
        if (count % 2 == 0) {
            sign = 'X';
            player = 1;
        } else {
            sign = 'O';
            player = 2;
        }

        // MCQ gate (must answer 'level' correct MCQs)
        printf("\nPlayer %d must answer %d MCQ%s correctly before the move.\n",
               player, level, (level==1?"":"s"));
        mcq_gate_until_correct_n(level);

        // player move
        printf("move for player %d (1-9): ", player);
        if (scanf("%d", &index) != 1) {
            int c;
            while ((c = getchar()) != '\n' && c != EOF);
            printf("invalid input\n");
            continue;
        }

        if (index < 1 || index > 9) {
            printf("allowed index is 1 to 9.\n");
            continue;
        }
        if (pos[index - 1] == 'X' || pos[index - 1] == 'O') {
            printf("position is already occupied\n");
            continue;
        }

        pos[index - 1] = sign;
        count++;

        // row check
        for (i = 0; i < 3; i++) {
            if (pos[i*3] == sign && pos[i*3+1] == sign && pos[i*3+2] == sign) {
                winner = 1;
                win(player, winner, pos);
                break;
            }
        }
        if (winner) break;

        // column check
        for (i = 0; i < 3; i++) {
            if (pos[i] == sign && pos[i+3] == sign && pos[i+6] == sign) {
                winner = 1;
                win(player, winner, pos);
                break;
            }
        }
        if (winner) break;

        // diagonal check
        if ((pos[0]==sign && pos[4]==sign && pos[8]==sign) ||
            (pos[2]==sign && pos[4]==sign && pos[6]==sign)) {
            winner = 1;
            win(player, winner, pos);
            break;
        }
    }

    if (!winner) win(0, 0, pos);
    return 0;
}

//* ---- win() function ---- */
void win(int player, int winner, char pos[]) {
    printf("\n");
    printf(" %c | %c | %c\n", pos[0], pos[1], pos[2]);
    printf("---+---+---\n");
    printf(" %c | %c | %c\n", pos[3], pos[4], pos[5]);
    printf("---+---+---\n");
    printf(" %c | %c | %c\n", pos[6], pos[7], pos[8]);

    if (winner)
        printf("player %d is the winner\n", player);
    else
        printf("match is a draw\n");
}
